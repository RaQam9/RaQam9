<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم النهائية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0d1117; --bg-medium: #161b22; --border-color: #30363d;
            --text-primary: #c9d1d9; --text-secondary: #8b949e; --accent-blue: #2f81f7;
            --accent-red: #da3633; --accent-yellow: #f7b731; --accent-green: #238636;
            --accent-orange: #f0ad4e;
        }
        html { scroll-behavior: smooth; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg-dark); color: var(--text-primary); }
        .container { max-width: 1600px; margin: 2rem auto; padding: 0 1rem; }
        .card { background-color: var(--bg-medium); border-radius: 8px; border: 1px solid var(--border-color); padding: 1.5rem; }
        h1, h2, h3 { color: white; border-bottom: 1px solid var(--border-color); padding-bottom: 0.75rem; margin-bottom: 1.5rem; font-weight: 700; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary); }
        input, textarea, select { width: 100%; padding: 0.75rem; background-color: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); transition: all 0.2s; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(47, 129, 247, 0.3); }
        .hidden { display: none; }
        button { background-color: var(--accent-blue); color: white; padding: 0.75rem 1.5rem; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        button:disabled { background-color: var(--text-secondary); cursor: not-allowed; }
        button:hover:not(:disabled) { filter: brightness(1.2); }
        .tab-button { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); white-space: nowrap; padding: 0.5rem 1rem; }
        .tab-button.active { background-color: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 1rem; }
        .item-card { background-color: var(--bg-dark); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color); display: flex; flex-direction: column; justify-content: space-between; transition: all 0.2s; }
        .item-card:hover { transform: translateY(-4px); border-color: var(--accent-blue); }
        .item-card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; }
        .item-card-footer { margin-top: 1rem; display: flex; gap: 0.5rem; border-top: 1px solid var(--border-color); padding-top: 1rem; }
        .item-card-footer button { flex-grow: 1; padding: 0.5rem; font-size: 0.9em; }
        .delete-btn { background-color: var(--accent-red); }
        .edit-btn { background-color: var(--accent-orange); }
        .loader { width: 24px; height: 24px; border: 3px solid #f3f3f3; border-top: 3px solid var(--accent-blue); border-radius: 50%; animation: spin 1s linear infinite; margin: 2rem auto; }
        .sub-tab-button { background-color: var(--bg-medium); border: 1px solid var(--border-color); }
        .sub-tab-button.active { background-color: var(--accent-green); color: white; border-color: var(--accent-green); }
        .comment-content-grid { display: none; }
        .comment-content-grid.active { display: grid; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--bg-medium); padding: 2rem; border-radius: 8px; border: 1px solid var(--border-color); width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1.5rem; }
        .modal-close-btn { background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; }
    </style>
</head>
<body>
    <div id="login-screen" class="container max-w-md text-center card mt-20">
        <h1 class="text-2xl">تسجيل الدخول للمدير</h1>
        <input type="email" id="email-input" placeholder="البريد الإلكتروني" class="mt-4 text-center ltr">
        <input type="password" id="password-input" placeholder="كلمة المرور" class="mt-2 text-center ltr">
        <button id="login-button" class="mt-4 w-full"><i class="fas fa-sign-in-alt"></i> دخول</button>
        <p id="login-error" class="text-red-500 mt-2 hidden"></p>
    </div>

    <div id="admin-panel" class="container hidden">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
            <h1 class="text-3xl m-0 p-0 border-none">لوحة التحكم</h1>
            <div class="tabs flex flex-row-reverse gap-2 overflow-x-auto pb-2">
                <button class="tab-button active" data-tab="matches"><i class="fas fa-futbol"></i> المباريات</button>
                <button class="tab-button" data-tab="articles"><i class="fas fa-newspaper"></i> المقالات</button>
                <button class="tab-button" data-tab="comments"><i class="fas fa-comments"></i> التعليقات</button>
                <button class="tab-button" data-tab="predictions"><i class="fas fa-poll"></i> التوقعات</button>
            </div>
        </div>
        
        <div id="tab-matches" class="tab-content active"></div>
        <div id="tab-articles" class="tab-content"></div>
        <div id="tab-comments" class="tab-content"></div>
        <div id="tab-predictions" class="tab-content"></div>
    </div>
    
    <div id="edit-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title" class="text-2xl m-0 p-0 border-none">تعديل</h2>
                <button id="modal-close-button" class="modal-close-btn">×</button>
            </div>
            <form id="edit-form" class="space-y-4"></form>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // ==================== CONFIG & SETUP ====================
        const SUPABASE_URL = 'https://uxtxavurcgdeueeemmdi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4dHhhdnVyY2dkZXVlZWVtbWRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEwMjQ4NzYsImV4cCI6MjA2NjYwMDg3Nn0.j7MrIoGzbzjurKyWGN0GgpMBIzl5exOsZrYlKCSmNbk';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const LOCALE = 'fr-MA';

        if (!supabaseClient) { alert("فشل تهيئة Supabase."); return; }

        // ==================== DOM ELEMENTS & STATE ====================
        const loginScreen = document.getElementById('login-screen');
        const adminPanel = document.getElementById('admin-panel');
        const loginButton = document.getElementById('login-button');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const loginError = document.getElementById('login-error');
        
        const tabContents = {
            matches: document.getElementById('tab-matches'),
            articles: document.getElementById('tab-articles'),
            comments: document.getElementById('tab-comments'),
            predictions: document.getElementById('tab-predictions'),
        };

        const editModal = document.getElementById('edit-modal');
        const modalTitle = document.getElementById('modal-title');
        const editForm = document.getElementById('edit-form');
        const modalCloseButton = document.getElementById('modal-close-button');


        // ==================== UI INITIALIZATION ====================
        function initializePanels() {
            tabContents.matches.innerHTML = `<div class="grid grid-cols-1 xl:grid-cols-3 gap-6"><div class="xl:col-span-1 space-y-6"><section class="card"><h3 class="text-xl"><i class="fas fa-plus-circle"></i> إضافة مباراة</h3><form id="add-match-form" class="space-y-4 mt-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label>الفريق الأول:</label><input type="text" name="team1_name" required></div><div><label>شعار الفريق الأول:</label><input type="url" name="team1_logo" required></div><div><label>الفريق الثاني:</label><input type="text" name="team2_name" required></div><div><label>شعار الفريق الثاني:</label><input type="url" name="team2_logo" required></div></div><div><label>الدوري:</label><input type="text" name="league" required></div><div><label>التاريخ والوقت:</label><input type="datetime-local" name="datetime" required></div><div><label>القنوات (فاصلة ,):</label><input type="text" name="channels"></div><button type="submit" class="w-full"><i class="fas fa-save"></i> حفظ المباراة</button></form></section><section class="card"><h3 class="text-xl"><i class="fas fa-upload"></i> إضافة مباريات دفعة واحدة</h3><form id="bulk-add-matches-form" class="space-y-4 mt-4"><div><label>لصق بيانات المباريات هنا:</label><p class="text-xs text-gray-400 mb-2">كل مباراة في سطر. التنسيق: <br><code class="text-yellow-400 text-left block" dir="ltr">Team1,Logo1,Team2,Logo2,League,YYYY-MM-DD HH:MM,Channels</code></p><textarea id="bulk-matches-input" class="h-40 font-mono text-left" dir="ltr" required placeholder="ريال مدريد,https://.../real.png,برشلونة,https://.../barca.png,الدوري الإسباني,2024-10-26 22:00,beIN Sports 1\nمانشستر سيتي,..."></textarea></div><button type="submit" class="w-full bg-green-600 hover:bg-green-700"><i class="fas fa-check-double"></i> إضافة الكل</button></form></section></div><div class="card xl:col-span-2"><div class="flex justify-between items-center mb-4"><h3 class="text-xl m-0 p-0 border-none"><i class="fas fa-list-ul"></i> المباريات الحالية</h3><div class="flex items-center gap-4"><div class="flex items-center gap-2"><input type="checkbox" id="select-all-matches" class="w-4 h-4"><label for="select-all-matches" class="m-0 text-sm">تحديد الكل</label></div><button id="delete-selected-matches-btn" class="delete-btn" disabled><i class="fas fa-trash-alt"></i> حذف المحدد</button></div></div><div id="matches-grid" class="items-grid mt-4 max-h-[80vh] overflow-y-auto p-2"></div></div></div>`;
            
            tabContents.articles.innerHTML = `<div class="grid grid-cols-1 xl:grid-cols-3 gap-6"><div class="xl:col-span-1 space-y-6"><section class="card"><h3 class="text-xl"><i class="fas fa-pen-alt"></i> إضافة مقال</h3><form id="add-article-form" class="space-y-4 mt-4"><div><label>عنوان المقال:</label><input type="text" name="title" required></div><div><label>رابط صورة المقال:</label><input type="url" name="image_url" required></div><div><label>المحتوى (HTML):</label><textarea name="content" class="h-40 font-mono text-left" dir="ltr" required></textarea></div><button type="submit" class="w-full"><i class="fas fa-paper-plane"></i> نشر المقال</button></form></section><section class="card"><h3 class="text-xl"><i class="fas fa-upload"></i> إضافة مقالات دفعة واحدة</h3><form id="bulk-add-articles-form" class="space-y-4 mt-4"><div><label>لصق بيانات المقالات هنا:</label><p class="text-xs text-gray-400 mb-2">كل مقال في سطر. استخدم الفاصل <code class="text-yellow-400">|</code>. التنسيق: <br><code class="text-yellow-400 text-left block" dir="ltr">Title|ImageURL|Content</code></p><textarea id="bulk-articles-input" class="h-40 font-mono text-left" dir="ltr" required placeholder="عنوان المقال الأول|https://.../img1.png|محتوى المقال هنا...\nعنوان المقال الثاني|https://.../img2.png|محتوى المقال الثاني هنا..."></textarea></div><button type="submit" class="w-full bg-green-600 hover:bg-green-700"><i class="fas fa-check-double"></i> إضافة الكل</button></form></section></div><div class="card xl:col-span-2"><h3 class="text-xl"><i class="fas fa-list-ul"></i> المقالات المنشورة</h3><div id="articles-grid" class="items-grid mt-4 max-h-[80vh] overflow-y-auto p-2"></div></div></div>`;

            tabContents.comments.innerHTML = `<div class="card"><h3 class="text-xl"><i class="fas fa-comments"></i> إدارة التعليقات</h3><div id="comment-sub-tabs" class="flex gap-2 mb-4 border-b border-gray-700 pb-2"><button class="sub-tab-button active" data-comment-type="matches">تعليقات المباريات</button><button class="sub-tab-button" data-comment-type="articles">تعليقات المقالات</button></div><div id="match-comments-grid" class="comment-content-grid active items-grid max-h-[70vh] overflow-y-auto p-2"></div><div id="article-comments-grid" class="comment-content-grid items-grid max-h-[70vh] overflow-y-auto p-2"></div></div>`;
            tabContents.predictions.innerHTML = `<div class="card"><h3 class="text-xl"><i class="fas fa-poll"></i> جميع التوقعات</h3><div id="predictions-management-grid" class="items-grid mt-4 max-h-[70vh] overflow-y-auto p-2"></div></div>`;
            
            document.getElementById('add-match-form')?.addEventListener('submit', handleAddOrUpdate);
            document.getElementById('bulk-add-matches-form')?.addEventListener('submit', handleBulkAddMatches);
            document.getElementById('add-article-form')?.addEventListener('submit', handleAddOrUpdate);
            document.getElementById('bulk-add-articles-form')?.addEventListener('submit', handleBulkAddArticles);
        }

        // ==================== AUTH & TABS ====================
        const login = async () => {
            loginButton.disabled = true;
            loginButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جار الدخول...';
            loginError.classList.add('hidden');

            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email: emailInput.value.trim(),
                password: passwordInput.value,
            });

            if (error) {
                let errorMessage = '';
                if (error.message.includes('Invalid login credentials')) {
                    errorMessage = 'البريد الإلكتروني أو كلمة المرور غير صحيحة.';
                } else if (error.message.includes('Email not confirmed')) {
                    errorMessage = 'الحساب غير مؤكد. يرجى مراجعة بريدك الإلكتروني أو إعدادات Supabase.';
                } else {
                    errorMessage = `حدث خطأ: ${error.message}`;
                }
                loginError.textContent = errorMessage;
                loginError.classList.remove('hidden');
                loginButton.disabled = false;
                loginButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> دخول';
            } else {
                loginScreen.style.display = 'none';
                adminPanel.style.display = 'block';
                initializePanels();
                loadAllData();
            }
        };
        loginButton.addEventListener('click', login);
        passwordInput.addEventListener('keyup', (e) => e.key === 'Enter' && login());

        document.querySelector('.tabs')?.addEventListener('click', (e) => {
            const target = e.target.closest('button.tab-button'); if (!target) return;
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            target.classList.add('active');
            Object.values(tabContents).forEach(content => content.classList.remove('active'));
            tabContents[target.dataset.tab].classList.add('active');
        });

        // ==================== DATA LOADING & RENDERING ====================
        const loadAllData = () => { 
            loadData.matches(); 
            loadData.articles(); 
            loadData.matchComments(); 
            loadData.articleComments(); 
            loadData.predictions(); 
        };

        const loadData = {
            matches: async () => { 
                const grid = document.getElementById('matches-grid'); if(!grid) return;
                grid.innerHTML = '<div class="loader"></div>';
                const { data, error } = await supabaseClient.from('matches').select('*').order('datetime', { ascending: false });
                if (error) { grid.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`; return; }
                grid.innerHTML = data.length === 0 ? '<p>لا توجد مباريات حالية.</p>' : data.map(renderData.match).join('');
                updateDeleteButtonState();
            },
            articles: async () => { 
                const grid = document.getElementById('articles-grid'); if(!grid) return;
                grid.innerHTML = '<div class="loader"></div>';
                const { data, error } = await supabaseClient.from('articles').select('*').order('created_at', { ascending: false });
                if (error) { grid.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`; return; }
                grid.innerHTML = data.length === 0 ? '<p>لا توجد مقالات منشورة.</p>' : data.map(renderData.article).join('');
            },
            matchComments: async () => {
                 const grid = document.getElementById('match-comments-grid'); if(!grid) return;
                 grid.innerHTML = '<div class="loader"></div>';
                 const { data, error } = await supabaseClient.from('comments').select('*, matches(team1_name, team2_name)').order('created_at', { ascending: false });
                 if (error) { grid.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`; return; }
                 grid.innerHTML = data.length === 0 ? '<p>لا توجد تعليقات على المباريات.</p>' : data.map(renderData.matchComment).join('');
            },
            articleComments: async () => {
                 const grid = document.getElementById('article-comments-grid'); if(!grid) return;
                 grid.innerHTML = '<div class="loader"></div>';
                 const { data, error } = await supabaseClient.from('news_comments').select('*, articles(title)').order('created_at', { ascending: false });
                 if (error) { grid.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`; return; }
                 grid.innerHTML = data.length === 0 ? '<p>لا توجد تعليقات على المقالات.</p>' : data.map(renderData.articleComment).join('');
            },
            predictions: async () => {
                const grid = document.getElementById('predictions-management-grid'); if(!grid) return;
                grid.innerHTML = '<div class="loader"></div>';
                const { data, error } = await supabaseClient.from('predictions').select('*, matches(team1_name, team2_name)').order('created_at', { ascending: false });
                if (error) { grid.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`; return; }
                grid.innerHTML = data.length === 0 ? '<p>لا توجد توقعات.</p>' : data.map(renderData.prediction).join('');
            }
        };

        const renderData = {
            match: (match) => { 
                const matchDate = new Date(match.datetime);
                const isFutureMatch = matchDate > new Date();
                const dt = match.datetime.split('T');
                const datePart = dt[0].split('-').reverse().join('/');
                const timePart = dt.length > 1 ? dt[1].substring(0, 5) : '';
                const formattedDate = `${datePart} - ${timePart}`;

                return `<div class="item-card"><div class="item-card-header"><div class="flex-grow"><div class="flex justify-between items-center mb-2"><div class="flex items-center gap-2"><img src="${match.team1_logo}" class="w-6 h-6 object-contain"><span class="font-bold">${match.team1_name}</span></div><span class="text-gray-400">ضد</span><div class="flex items-center gap-2"><span class="font-bold">${match.team2_name}</span><img src="${match.team2_logo}" class="w-6 h-6 object-contain"></div></div><p class="text-sm text-center text-yellow-400 mb-2">${match.league}</p><p class="text-sm text-center text-gray-400" dir="ltr">${formattedDate}</p></div><input type="checkbox" class="match-checkbox w-5 h-5 flex-shrink-0" data-id="${match.id}"></div><div class="item-card-footer">${isFutureMatch ? `<button class="edit-btn" data-type="match" data-id="${match.id}"><i class="fas fa-edit"></i> تعديل</button>` : ''}<button class="delete-btn" data-type="match" data-id="${match.id}"><i class="fas fa-trash"></i> حذف</button></div></div>`;
            },
            article: (article) => { 
                return `<div class="item-card"><div><img src="${article.image_url}" alt="${article.title}" class="w-full h-32 object-cover rounded-md mb-2"><h4 class="font-bold text-white mb-2">${article.title}</h4><p class="text-xs text-gray-400">تاريخ النشر: ${new Date(article.created_at).toLocaleDateString(LOCALE)}</p></div><div class="item-card-footer"><button class="edit-btn" data-type="article" data-id="${article.id}"><i class="fas fa-edit"></i> تعديل</button><button class="delete-btn" data-type="article" data-id="${article.id}"><i class="fas fa-trash"></i> حذف</button></div></div>`;
            },
            matchComment: (comment) => `<div class="item-card"><p class="font-bold text-white">"${comment.comment_text}"</p><p class="text-sm text-gray-400">بواسطة: ${comment.author} - على مباراة: <span class="text-yellow-400">${comment.matches ? `${comment.matches.team1_name} ضد ${comment.matches.team2_name}` : 'مباراة محذوفة'}</span></p><div class="item-card-footer"><button class="delete-btn" data-type="match_comment" data-id="${comment.id}"><i class="fas fa-trash"></i> حذف</button></div></div>`,
            articleComment: (comment) => `<div class="item-card"><p class="font-bold text-white">"${comment.comment_text}"</p><p class="text-sm text-gray-400">بواسطة: ${comment.author} - على مقال: <span class="text-yellow-400">${comment.articles ? comment.articles.title : 'مقال محذوف'}</span></p><div class="item-card-footer"><button class="delete-btn" data-type="article_comment" data-id="${comment.id}"><i class="fas fa-trash"></i> حذف</button></div></div>`,
            prediction: (prediction) => `<div class="item-card"><p class="font-bold text-white">"الفائز: ${prediction.predicted_winner || 'لم يحدد'} | الهداف: ${prediction.predicted_scorer || 'لم يحدد'}"</p><p class="text-sm text-gray-400 mt-2">بواسطة: ${prediction.social_account || 'مجهول'} - على مباراة: <span class="text-yellow-400">${prediction.matches ? `${prediction.matches.team1_name} ضد ${prediction.matches.team2_name}` : 'مباراة محذوفة'}</span></p><div class="item-card-footer"><button class="delete-btn" data-type="prediction" data-id="${prediction.id}"><i class="fas fa-trash"></i> حذف</button></div></div>`
        };

        // ==================== ACTIONS HANDLING ====================
        const handleAddOrUpdate = async (e) => {
            e.preventDefault();
            const form = e.target;
            const button = form.querySelector('button[type="submit"]');
            button.disabled = true;

            const isMatchForm = form.id === 'add-match-form';
            const table = isMatchForm ? 'matches' : 'articles';
            const refreshFunc = isMatchForm ? loadData.matches : loadData.articles;
            
            const formData = new FormData(form);
            const dataToInsert = Object.fromEntries(formData.entries());

            // For match form, handle channels
            if (isMatchForm && dataToInsert.channels) {
                dataToInsert.channels = dataToInsert.channels.split(',').map(ch => ch.trim()).filter(ch => ch !== '');
            }

            const { error } = await supabaseClient.from(table).insert([dataToInsert]);
            
            if (error) {
                alert(`فشل الإضافة: ${error.message}`);
            } else {
                alert('تمت الإضافة بنجاح!');
                form.reset();
                refreshFunc();
            }
            button.disabled = false;
        };
        
        const handleBulkAddMatches = async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            const textarea = document.getElementById('bulk-matches-input');
            const rawText = textarea.value.trim();
            if (!rawText) return;

            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جار الإضافة...';
            
            const lines = rawText.split('\n').filter(line => line.trim() !== '');
            const matchesToInsert = [];
            const failedLines = [];

            lines.forEach((line, i) => {
                const parts = line.split(',').map(p => p.trim());
                if (parts.length < 7) { failedLines.push(i + 1); return; }
                const [team1_name, team1_logo, team2_name, team2_logo, league, datetimeStr, ...channelsParts] = parts;
                if (!team1_name || !team1_logo || !team2_name || !team2_logo || !league || !datetimeStr) {
                    failedLines.push(i + 1); return;
                }
                matchesToInsert.push({ team1_name, team1_logo, team2_name, team2_logo, league, datetime: datetimeStr.replace(' ', 'T'), channels: channelsParts.join(',') });
            });

            if (matchesToInsert.length > 0) {
                const { error } = await supabaseClient.from('matches').insert(matchesToInsert);
                if (error) {
                    alert(`حدث خطأ: ${error.message}`);
                } else {
                    let msg = `تم إضافة ${matchesToInsert.length} مباراة بنجاح!`;
                    if (failedLines.length > 0) msg += `\nفشلت الأسطر: ${failedLines.join(', ')}.`;
                    alert(msg);
                    textarea.value = '';
                    loadData.matches();
                }
            } else {
                alert('لم يتم العثور على مباريات صالحة.');
            }
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-check-double"></i> إضافة الكل';
        };

        const handleBulkAddArticles = async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            const textarea = document.getElementById('bulk-articles-input');
            const rawText = textarea.value.trim();
            if (!rawText) return;

            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جار الإضافة...';
            
            const lines = rawText.split('\n').filter(line => line.trim() !== '');
            const articlesToInsert = [];
            const failedLines = [];

            lines.forEach((line, i) => {
                const parts = line.split('|').map(p => p.trim());
                if (parts.length !== 3) {
                    failedLines.push(i + 1);
                    return;
                }
                
                const [title, image_url, content] = parts;
                if (!title || !image_url || !content) {
                    failedLines.push(i + 1);
                    return;
                }
                articlesToInsert.push({ title, image_url, content });
            });

            if (articlesToInsert.length > 0) {
                const { error } = await supabaseClient.from('articles').insert(articlesToInsert);
                if (error) {
                    alert(`حدث خطأ أثناء إضافة المقالات: ${error.message}`);
                } else {
                    let msg = `تم إضافة ${articlesToInsert.length} مقال بنجاح!`;
                    if (failedLines.length > 0) {
                        msg += `\nفشلت الأسطر التالية بسبب تنسيق خاطئ: ${failedLines.join(', ')}.`;
                    }
                    alert(msg);
                    textarea.value = '';
                    loadData.articles();
                }
            } else {
                alert('لم يتم العثور على مقالات صالحة للإضافة. يرجى مراجعة التنسيق.');
            }
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-check-double"></i> إضافة الكل';
        };

        const handleBulkDeleteMatches = async () => {
            const selectedIds = Array.from(document.querySelectorAll('.match-checkbox:checked')).map(cb => cb.dataset.id);
            if (selectedIds.length === 0 || !confirm(`هل أنت متأكد من حذف ${selectedIds.length} مباراة؟`)) return;

            const button = document.getElementById('delete-selected-matches-btn');
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            const { error } = await supabaseClient.from('matches').delete().in('id', selectedIds);
            
            if (error) {
                alert(`فشل الحذف الجماعي: ${error.message}`);
            } else {
                alert('تم الحذف بنجاح!');
                loadData.matches();
            }
            button.innerHTML = '<i class="fas fa-trash-alt"></i> حذف المحدد';
        };
        
        const openEditModal = async (type, id) => {
            let formHtml = '';
            let title = '';
            let tableName = type === 'match' ? 'matches' : 'articles';
            
            const { data, error } = await supabaseClient.from(tableName).select('*').eq('id', id).single();
            if (error) { alert(`خطأ: ${error.message}`); return; }

            if (type === 'match') {
                title = `تعديل مباراة`;
                // <-- التصحيح هنا: تحويل مصفوفة القنوات إلى نص للعرض
                const channelsText = (data.channels || []).join(', ');
                formHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label>الفريق الأول:</label><input type="text" name="team1_name" value="${data.team1_name}" required></div><div><label>شعار الفريق الأول:</label><input type="url" name="team1_logo" value="${data.team1_logo}" required></div><div><label>الفريق الثاني:</label><input type="text" name="team2_name" value="${data.team2_name}" required></div><div><label>شعار الفريق الثاني:</label><input type="url" name="team2_logo" value="${data.team2_logo}" required></div></div><div><label>الدوري:</label><input type="text" name="league" value="${data.league}" required></div><div><label>التاريخ والوقت:</label><input type="datetime-local" name="datetime" value="${data.datetime.slice(0, 16)}" required></div><div><label>القنوات (فاصلة ,):</label><input type="text" name="channels" value="${channelsText}"></div><button type="submit" class="w-full mt-4"><i class="fas fa-save"></i> حفظ التعديلات</button>`;
            } else if (type === 'article') {
                title = `تعديل مقال`;
                formHtml = `<div><label>عنوان المقال:</label><input type="text" name="title" value="${data.title}" required></div><div><label>رابط الصورة:</label><input type="url" name="image_url" value="${data.image_url}" required></div><div><label>المحتوى (HTML):</label><textarea name="content" class="h-48 font-mono text-left" dir="ltr" required>${data.content}</textarea></div><button type="submit" class="w-full mt-4"><i class="fas fa-save"></i> حفظ التعديلات</button>`;
            }
            modalTitle.textContent = title;
            editForm.innerHTML = formHtml;
            editForm.dataset.type = type;
            editForm.dataset.id = id;
            editModal.classList.remove('hidden');
        };

        const handleUpdateInModal = async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            const { type, id } = e.target.dataset;
            const formData = new FormData(e.target);
            const updatedData = Object.fromEntries(formData.entries());
            const tableName = type === 'match' ? 'matches' : 'articles';

            // <-- التصحيح هنا: تحويل نص القنوات إلى مصفوفة قبل الإرسال
            if (type === 'match' && typeof updatedData.channels === 'string') {
                if (updatedData.channels.trim() === '') {
                    updatedData.channels = []; // إرسال مصفوفة فارغة إذا كان الحقل فارغاً
                } else {
                    updatedData.channels = updatedData.channels.split(',').map(ch => ch.trim()).filter(ch => ch !== '');
                }
            }
            
            const { error } = await supabaseClient.from(tableName).update(updatedData).eq('id', id);

            if (error) {
                alert(`فشل التحديث: ${error.message}`);
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-save"></i> حفظ التعديلات';
            } else {
                alert('تم التحديث بنجاح!');
                editModal.classList.add('hidden');
                if (type === 'match') loadData.matches();
                else if (type === 'article') loadData.articles();
            }
        };

        const updateDeleteButtonState = () => {
            const deleteBtn = document.getElementById('delete-selected-matches-btn');
            const selectAllCheckbox = document.getElementById('select-all-matches');
            if (!deleteBtn || !selectAllCheckbox) return;

            const checkedCount = document.querySelectorAll('.match-checkbox:checked').length;
            const allCount = document.querySelectorAll('.match-checkbox').length;
            
            deleteBtn.disabled = checkedCount === 0;
            selectAllCheckbox.checked = allCount > 0 && checkedCount === allCount;
        };

        // Event Delegation for the whole panel
        adminPanel.addEventListener('click', async (e) => {
            const target = e.target;
            
            // Delete Buttons
            const deleteBtn = target.closest('button.delete-btn');
            if (deleteBtn) {
                const type = deleteBtn.dataset.type;
                const id = deleteBtn.dataset.id;
                if (!confirm(`هل أنت متأكد من الحذف؟`)) return;
                
                let table, refreshFunc;
                switch(type) {
                    case 'match': table = 'matches'; refreshFunc = loadData.matches; break;
                    case 'article': table = 'articles'; refreshFunc = loadData.articles; break;
                    case 'prediction': table = 'predictions'; refreshFunc = loadData.predictions; break;
                    case 'match_comment': table = 'comments'; refreshFunc = loadData.matchComments; break;
                    case 'article_comment': table = 'news_comments'; refreshFunc = loadData.articleComments; break;
                    default: return;
                }
                const { error } = await supabaseClient.from(table).delete().eq('id', id);
                if (error) { alert(`فشل الحذف: ${error.message}`); } 
                else { alert('تم الحذف!'); refreshFunc(); }
                return;
            }

            // Edit Buttons
            const editBtn = target.closest('button.edit-btn');
            if (editBtn) {
                openEditModal(editBtn.dataset.type, editBtn.dataset.id);
                return;
            }

            // Bulk Delete Button
            if (target.closest('#delete-selected-matches-btn')) {
                handleBulkDeleteMatches();
                return;
            }
            
            // Comment Sub-tabs
            const subTabButton = target.closest('.sub-tab-button');
            if (subTabButton && subTabButton.parentElement.id === 'comment-sub-tabs') {
                document.querySelectorAll('#comment-sub-tabs .sub-tab-button').forEach(btn => btn.classList.remove('active'));
                subTabButton.classList.add('active');
                document.querySelectorAll('.comment-content-grid').forEach(grid => grid.classList.remove('active'));
                const gridId = subTabButton.dataset.commentType === 'matches' ? 'match-comments-grid' : 'article-comments-grid';
                document.getElementById(gridId)?.classList.add('active');
            }
        });

        adminPanel.addEventListener('change', (e) => {
            if (e.target.id === 'select-all-matches' || e.target.classList.contains('match-checkbox')) {
                if (e.target.id === 'select-all-matches') {
                    document.querySelectorAll('.match-checkbox').forEach(cb => cb.checked = e.target.checked);
                }
                updateDeleteButtonState();
            }
        });
        
        // Modal Listeners
        modalCloseButton.addEventListener('click', () => editModal.classList.add('hidden'));
        editForm.addEventListener('submit', handleUpdateInModal);

    });
    </script>
</body>
</html>
