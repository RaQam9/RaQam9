<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>المركز الرياضي - نسخة كاملة</title>
    
    <!-- Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Fonts and Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { 'tajawal': ['Tajawal', 'sans-serif'] } } } }
    </script>
    
    <!-- CSS Styles -->
    <style>
        :root{--bg-color:#0d1117;--surface-color:#161b22;--primary-text-color:#c9d1d9;--secondary-text-color:#8b949e;--accent-color:#2f81f7;--border-color:#30363d;--success-color:#238636;--danger-color:#da3633;--warning-color:#f7b731;--channel-color:#facc15}*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Tajawal',sans-serif;background-color:var(--bg-color);color:var(--primary-text-color);line-height:1.6;overflow-x:hidden}.page-container.hidden{display:none}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);justify-content:center;align-items:center}.modal.show{display:flex}.modal-content{background-color:var(--surface-color);padding:25px;border-radius:12px;width:90%;max-width:450px;position:relative;border-top:4px solid var(--accent-color)}.modal-content h2{font-size:1.4rem;margin-bottom:20px;text-align:center}.modal .form-control input{width:100%;padding:12px;background-color:var(--border-color);color:var(--primary-text-color);border:1px solid var(--border-color);border-radius:6px;font-size:1rem}.modal .form-control{margin-bottom:15px}.modal .form-control label{display:block;margin-bottom:8px;font-size:0.9rem;color:var(--secondary-text-color)}.modal button.submit-btn{width:100%;padding:12px;background-color:var(--accent-color);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:700}.close-button{position:absolute;top:15px;right:15px;color:var(--secondary-text-color);font-size:24px;cursor:pointer}#predictions-page .container{max-width:800px;margin:0 auto;padding:15px}#predictions-page header h1,#news-page header h1{text-align:center;font-size:1.8rem;margin-bottom:15px;font-weight:700;padding:15px 0}#predictions-page .floating-icon-container{position:fixed;bottom:20px;left:20px;display:flex;align-items:center;gap:8px;z-index:1001}#predictions-page .user-icon-button{background-color:var(--accent-color);color:white;width:45px;height:45px;border-radius:50%;border:none;font-size:1.2rem;display:flex;justify-content:center;align-items:center;cursor:pointer;box-shadow:0 4px 15px rgba(0,0,0,.3)}#predictions-page .news-ticker{background-color:var(--surface-color);border-radius:8px;padding:10px 15px;margin-bottom:25px;display:flex;align-items:center;overflow:hidden;border:1px solid var(--border-color)}#predictions-page .ticker-icon{color:var(--accent-color);font-size:1.2rem;margin-left:15px}#predictions-page .ticker-content{white-space:nowrap;animation:ticker-scroll-rtl 25s linear infinite}@keyframes ticker-scroll-rtl{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}#predictions-page .ticker-item{display:inline-block;margin-right:50px;font-size:.9rem;color:var(--secondary-text-color)}.date-tabs-container{display:flex;width:100%;border-radius:8px;overflow:hidden;background-color:var(--surface-color);margin-bottom:20px;border:1px solid var(--border-color)}.date-tab{flex-grow:1;text-align:center;padding:12px 10px;cursor:pointer;color:var(--secondary-text-color);border-bottom:4px solid transparent;transition:all .2s;font-weight:700;font-size:1.1rem}.date-tab.active{color:var(--primary-text-color);background-color:rgba(47,129,247,.15);border-bottom-color:var(--accent-color)}.day-content{display:none}.day-content.active{display:block;animation:fadeIn .5s}@keyframes fadeIn{from{opacity:0}to{opacity:1}}#predictions-page .match-card{background-color:var(--surface-color);border:1px solid var(--border-color);border-radius:8px;overflow:hidden;margin-bottom:15px}#predictions-page .match-header{padding:10px 15px;display:flex;justify-content:space-between;align-items:center;background-color:rgba(47,129,247,.1)}#predictions-page .match-league{font-weight:700;color:var(--accent-color)}#predictions-page .match-date-time{font-size:.9rem;color:var(--secondary-text-color)}#predictions-page .match-body{padding:20px}#predictions-page .teams-row{display:flex;justify-content:space-around;align-items:center;margin-bottom:20px}#predictions-page .team{text-align:center;width:120px}#predictions-page .team img{width:50px;height:50px;object-fit:contain;margin-bottom:10px}#predictions-page .team-name{font-weight:700;font-size:1rem}#predictions-page .match-status-container{text-align:center}#predictions-page .match-time{font-size:1.2rem;font-weight:700;direction:ltr}#predictions-page .match-status{font-size:1rem;font-weight:700;padding:4px 8px;border-radius:6px}#predictions-page .match-status.soon{color:white;background-color:var(--success-color)}#predictions-page .match-status.live{color:white;background-color:var(--warning-color);animation:pulse 1.5s infinite}@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(247,183,49,.7)}70%{box-shadow:0 0 0 10px rgba(247,183,49,0)}100%{box-shadow:0 0 0 0 rgba(247,183,49,0)}}#predictions-page .match-status.ended{color:white;background-color:var(--danger-color)}#predictions-page .prediction-form,#predictions-page .comment-form{background-color:var(--bg-color);padding:15px;border-radius:8px;border:1px solid var(--border-color)}#predictions-page .prediction-form.disabled{opacity:.6;pointer-events:none}#predictions-page .form-group{margin-bottom:15px}#predictions-page .form-group legend{font-size:1rem;font-weight:500;color:var(--secondary-text-color);margin-bottom:10px;display:flex;align-items:center;gap:8px}#predictions-page .channel-info span{color:var(--channel-color);font-weight:700}#predictions-page .prediction-options{display:flex;gap:10px}#predictions-page .prediction-options input[type=radio]{display:none}#predictions-page .prediction-options label{flex-grow:1;padding:10px;border-radius:6px;border:1px solid var(--border-color);text-align:center;cursor:pointer;transition:all .2s}#predictions-page .prediction-options input[type=radio]:checked+label{background-color:var(--success-color);border-color:var(--success-color);color:#fff;font-weight:700}#predictions-page .scorer-input{width:100%;padding:10px;background-color:var(--border-color);color:var(--primary-text-color);border:1px solid var(--border-color);border-radius:6px}#predictions-page .submit-btn{width:100%;padding:12px;background-color:var(--accent-color);color:white;border:none;border-radius:8px;font-size:1.1rem;font-weight:700;cursor:pointer;display:flex;justify-content:center;align-items:center;gap:8px}#predictions-page .submit-btn:disabled{background-color:var(--success-color);opacity:.8;cursor:not-allowed}#predictions-page .match-footer{padding:0 20px 20px}#predictions-page .toggle-comments-btn{width:100%;padding:10px;background:transparent;border:1px solid var(--border-color);color:var(--secondary-text-color);cursor:pointer;border-radius:8px;margin-top:15px}#predictions-page .comments-section{display:none;margin-top:15px}#predictions-page .comment-list{margin-bottom:15px;max-height:200px;overflow-y:auto}#predictions-page .comment{display:flex;gap:10px;margin-bottom:15px}#predictions-page .comment-avatar{width:35px;height:35px;border-radius:50%;background-color:var(--border-color);display:flex;justify-content:center;align-items:center}#predictions-page .comment-body{flex:1}#predictions-page .comment-author{font-weight:700}#predictions-page .comment-text{font-size:.9rem;color:var(--secondary-text-color)}#predictions-page .comment-form textarea{width:100%;min-height:60px;padding:10px;background-color:var(--bg-color);border:1px solid var(--border-color);border-radius:6px;resize:vertical;margin-bottom:10px}#predictions-page .comment-form button{padding:8px 15px;background-color:var(--accent-color);color:white;border:none;border-radius:6px;cursor:pointer}#predictions-page .fa-spin{animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}#news-page .page{position:absolute;top:0;left:0;width:100%;height:100%;padding:15px;padding-top:0;overflow-y:auto;background-color:var(--bg-color);transition:transform .35s ease-in-out;display:flex;flex-direction:column}#news-page #home-page{transform:translateX(0);z-index:10}#news-page #article-page{transform:translateX(100%);z-index:20;touch-action:pan-y}#news-page #article-content{padding-top:15px;padding-bottom:10px}#news-page #article-header{display:flex;justify-content:space-between;align-items:flex-start;gap:15px;margin-bottom:10px}#news-page #article-header h1{font-size:1.8rem;flex-grow:1;line-height:1.4}#news-page #article-content img{width:100%;max-height:400px;object-fit:cover;border-radius:8px;margin-bottom:20px}#news-page #article-content p{font-size:1.1rem;line-height:1.8;margin-bottom:15px;color:var(--secondary-text-color)}#news-page .news-comments-section{padding:20px 0;margin-top:25px;border-top:1px solid var(--border-color)}#news-page .news-comments-section h2{font-size:1.5rem;margin-bottom:20px}#news-page .comment-item{background-color:var(--surface-color);border:1px solid var(--border-color);border-radius:8px;padding:15px;margin-bottom:10px;position:relative}#news-page .comment-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;color:var(--secondary-text-color);font-size:.9rem;flex-wrap:wrap}#news-page .comment-author{font-weight:700}#news-page .comment-body{font-size:1rem;line-height:1.7;white-space:pre-wrap;word-wrap:break-word}#news-page #news-comment-form input,#news-page #news-comment-form textarea{width:100%;padding:12px;background-color:var(--bg-color);border:1px solid var(--border-color);border-radius:8px;color:var(--primary-text-color);margin-bottom:10px;font-size:1rem}#news-page #news-comment-form button{width:100%;background-color:var(--accent-color);color:white;border:none;cursor:pointer;font-weight:700;padding:12px;border-radius:8px;font-size:1rem;transition:background-color .2s}#news-page #news-comment-form button:disabled{background-color:var(--secondary-text-color);cursor:not-allowed}#news-page #articles-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;padding-bottom:80px}#news-page .article-card{background-color:var(--surface-color);border:1px solid var(--border-color);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;cursor:pointer;transition:transform .2s ease,box-shadow .2s ease;position:relative}#news-page .article-card img{width:100%;height:180px;object-fit:cover}#news-page .article-card .article-title{padding:15px;font-size:1.1rem;font-weight:700;flex-grow:1}
    </style>
</head>
<body class="bg-[#0d1117]">

    <!-- Navigation Bar -->
    <nav class="bg-[#161b22] border-b border-[#30363d] p-3 sticky top-0 z-50">
        <div class="container mx-auto flex justify-center items-center gap-4">
            <button id="nav-predictions-btn" class="nav-btn bg-blue-600 text-white px-6 py-2 rounded-md font-bold transition-all"><i class="fa-solid fa-trophy ml-2"></i> توقعات المباريات</button>
            <button id="nav-news-btn" class="nav-btn text-gray-400 px-6 py-2 rounded-md font-bold transition-all"><i class="fa-solid fa-newspaper ml-2"></i> أخبار كرة القدم</button>
        </div>
    </nav>

    <!-- Predictions Page -->
    <div id="predictions-page" class="page-container">
        <div class="container">
            <header><h1><i class="fa-solid fa-trophy"></i> توقعات المباريات</h1></header>
            <div id="news-ticker" class="news-ticker" style="display: none;"><i class="fa-solid fa-bell ticker-icon"></i><div class="ticker-content" id="predictions-ticker-content"></div></div>
            <main id="matches-container"><!-- Content for matches is loaded by JavaScript --></main>
        </div>
        <div class="floating-icon-container">
            <button class="user-icon-button" id="user-icon-btn" title="تسجيل الدخول / إنشاء حساب"><i class="fa-solid fa-user-plus"></i></button>
        </div>
    </div>
    
    <!-- News Page -->
    <div id="news-page" class="page-container hidden">
        <div id="home-page" class="page">
            <header><h1><i class="fa-solid fa-newspaper"></i> أخبار كرة القدم</h1></header>
            <main id="articles-grid"><!-- Grid for article cards --></main>
        </div>
        <div id="article-page" class="page">
            <div class="p-4" id="article-content-wrapper">
                <button id="back-to-news-list" class="mb-4 text-blue-400">← العودة للأخبار</button>
                <div id="article-content"><!-- Full article content --></div>
            </div>
            <div class="p-4 news-comments-section">
                <h2><i class="fa-solid fa-comments"></i> التعليقات</h2>
                <div id="news-comments-list"><!-- List of comments for the article --></div>
                <form id="news-comment-form" class="mt-4">
                    <h3>أضف تعليقك</h3>
                    <textarea name="comment_text" placeholder="اكتب تعليقك هنا..." required class="min-h-[80px]"></textarea>
                    <button type="submit" class="submit-btn">إرسال التعليق</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal for Auth/Guest -->
    <div class="modal" id="user-choice-modal">
        <div class="modal-content">
            <span class="close-button" id="close-choice-modal-btn">×</span>
            <div id="choice-view">
                <h2 class="font-bold">للمشاركة والتفاعل</h2>
                <p class="text-gray-400 mb-6 text-center">اختر طريقة المشاركة</p>
                <button id="show-login-view-btn" class="w-full mb-3 p-3 bg-blue-600 text-white rounded-lg font-bold">تسجيل الدخول / إنشاء حساب</button>
                <button id="show-guest-view-btn" class="w-full p-3 bg-gray-600 text-white rounded-lg font-bold">المتابعة كضيف</button>
            </div>
            <div id="auth-view" style="display: none;">
                <button id="back-to-choice-btn" class="mb-4 text-blue-400">← الرجوع للاختيار</button>
                <div id="login-view-inner">
                    <h2 class="font-bold">تسجيل الدخول</h2>
                    <form id="login-form">
                        <div class="form-control"><label for="login-email">البريد الإلكتروني</label><input type="email" id="login-email" required></div>
                        <div class="form-control"><label for="login-password">كلمة المرور</label><input type="password" id="login-password" required></div>
                        <button type="submit" class="submit-btn w-full">دخول</button>
                    </form>
                    <p class="text-center mt-4">ليس لديك حساب؟ <a href="#" id="show-signup-link-inner" class="text-blue-400">أنشئ حسابًا</a></p>
                </div>
                <div id="signup-view-inner" style="display: none;">
                    <h2 class="font-bold">إنشاء حساب جديد</h2>
                    <form id="signup-form">
                        <div class="form-control"><label for="signup-username">اسم المستخدم (سيظهر للجميع)</label><input type="text" id="signup-username" required></div>
                        <div class="form-control"><label for="signup-email">البريد الإلكتروني</label><input type="email" id="signup-email" required></div>
                        <div class="form-control"><label for="signup-password">كلمة المرور (6+ حروف)</label><input type="password" id="signup-password" minlength="6" required></div>
                        <button type="submit" class="submit-btn w-full">إنشاء الحساب</button>
                    </form>
                    <p class="text-center mt-4">لديك حساب بالفعل؟ <a href="#" id="show-login-link-inner" class="text-blue-400">سجل الدخول</a></p>
                </div>
                <div id="auth-status-inner" class="text-center mt-3 h-5"></div>
            </div>
            <div id="guest-view" style="display: none;">
                <h2 class="font-bold">المتابعة كضيف</h2>
                <form id="guest-form">
                    <div class="form-control">
                        <label for="guest-username">أدخل اسمًا ليظهر في التعليقات</label>
                        <input type="text" id="guest-username" required>
                    </div>
                    <button type="submit" class="submit-btn w-full">حفظ ومتابعة</button>
                </form>
                <p class="text-gray-400 mt-3 text-sm text-center">ملاحظة: لن يتم احتساب نقاطك في لوحة الصدارة عند اللعب كضيف.</p>
            </div>
        </div>
    </div>

<script>
// ==========================================================
// SECTION 0: GLOBAL SETUP & INITIALIZATION
// ==========================================================
const SUPABASE_URL = 'https://uxtxavurcgdeueeemmdi.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4dHhhdnVyY2dkZXVlZWVtbWRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEwMjQ4NzYsImV4cCI6MjA2NjYwMDg3Nn0.j7MrIoGzbzjurKyWGN0GgpMBIzl5exOsZrYlKCSmNbk';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const locale = 'ar-EG-u-nu-latn';

document.addEventListener('DOMContentLoaded', () => {
    // Page switching logic
    const predictionsBtn = document.getElementById('nav-predictions-btn');
    const newsBtn = document.getElementById('nav-news-btn');
    const predictionsPage = document.getElementById('predictions-page');
    const newsPage = document.getElementById('news-page');

    function switchPage(pageToShow) {
        const isPredictions = pageToShow === 'predictions';
        predictionsPage.classList.toggle('hidden', !isPredictions);
        newsPage.classList.toggle('hidden', isPredictions);
        predictionsBtn.classList.toggle('bg-blue-600', isPredictions);
        predictionsBtn.classList.toggle('text-white', isPredictions);
        predictionsBtn.classList.toggle('text-gray-400', !isPredictions);
        newsBtn.classList.toggle('bg-blue-600', !isPredictions);
        newsBtn.classList.toggle('text-white', !isPredictions);
        newsBtn.classList.toggle('text-gray-400', isPredictions);
    }

    predictionsBtn.addEventListener('click', () => switchPage('predictions'));
    newsBtn.addEventListener('click', () => switchPage('news'));

    // Initialize all app functionalities
    initializePredictionsPage();
    initializeNewsPage();
    setupAuthAndGuestListeners();
});

// ======================================================================
// SECTION 1: PREDICTIONS PAGE LOGIC
// ======================================================================
async function initializePredictionsPage() {
    await updateUserStatus();
    try {
        const container = document.getElementById('matches-container');
        container.innerHTML = '<p class="text-center text-gray-400 mt-8"><i class="fa-solid fa-spinner fa-spin mr-2"></i> جاري تحميل المباريات...</p>';
        let { data, error } = await supabaseClient.from('matches').select('*').order('datetime', { ascending: true });
        if (error) throw error;
        if (!data || data.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-400 mt-8">لا توجد مباريات متاحة حالياً.</p>';
            return;
        }
        const formattedMatches = data.map(match => ({
            id: match.id,
            team1: { name: match.team1_name, logo: match.team1_logo },
            team2: { name: match.team2_name, logo: match.team2_logo },
            league: match.league,
            datetime: match.datetime,
            channels: match.channels || []
        }));
        container.innerHTML = `<div class="date-tabs-container" id="date-tabs"></div><div id="days-content-container"></div>`;
        initializeAppWithData(formattedMatches);
    } catch (error) {
        console.error("Error initializing predictions page:", error);
        document.getElementById('matches-container').innerHTML = `<p class="text-center text-red-500 mt-8">فشل تحميل المباريات. يرجى التأكد من سياسات الأمان (RLS).</p>`;
    }
}

function initializeAppWithData(matchesData) {
    const dateTabsContainer = document.getElementById('date-tabs');
    const daysContentContainer = document.getElementById('days-content-container');
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const matchesByDay = matchesData
        .filter(m => new Date(new Date(m.datetime).toLocaleDateString('en-CA')) >= today)
        .reduce((acc, match) => {
            const dateKey = new Date(match.datetime).toLocaleDateString('en-CA');
            if (!acc[dateKey]) acc[dateKey] = [];
            acc[dateKey].push(match);
            return acc;
        }, {});

    if (Object.keys(matchesByDay).length === 0) {
        daysContentContainer.innerHTML = `<p class="text-center text-gray-400 mt-8">لا توجد مباريات قادمة.</p>`;
        return;
    }

    Object.keys(matchesByDay).sort().forEach((day, index) => {
        const tabEl = document.createElement('div');
        tabEl.className = `date-tab ${index === 0 ? 'active' : ''}`;
        tabEl.textContent = new Date(day + 'T00:00:00').toLocaleDateString(locale, { day: 'numeric', month: 'long' });
        tabEl.dataset.tabId = day;
        dateTabsContainer.appendChild(tabEl);

        const dayContentEl = document.createElement('div');
        dayContentEl.className = `day-content ${index === 0 ? 'active' : ''}`;
        dayContentEl.id = `day-${day}`;
        daysContentContainer.appendChild(dayContentEl);

        renderMatchesForDay(dayContentEl, sortMatches(matchesByDay[day]));
    });

    attachTabEventListeners();
    attachMatchEventListeners();
    loadPredictionsFromStorage();
    populateTicker();
}

function renderMatchesForDay(container, matches) {
    container.innerHTML = matches.map(createMatchCardHTML).join('');
}

function attachTabEventListeners() {
    document.getElementById('date-tabs')?.addEventListener('click', (e) => {
        if (!e.target.classList.contains('date-tab')) return;
        const tabId = e.target.dataset.tabId;
        document.querySelectorAll('.date-tab').forEach(tab => tab.classList.remove('active'));
        e.target.classList.add('active');
        document.querySelectorAll('.day-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`day-${tabId}`)?.classList.add('active');
    });
}

function attachMatchEventListeners() {
    const container = document.getElementById('days-content-container');
    if (!container) return;

    container.addEventListener('submit', (e) => {
        e.preventDefault();
        // Route to the correct handler based on the form's name
        if (e.target.matches('form[name="prediction-form"]')) {
            handleFormSubmit(e.target);
        } else if (e.target.matches('form[name="match-comment-form"]')) {
            handleMatchCommentSubmit(e.target);
        }
    });

    container.addEventListener('click', (e) => {
        const button = e.target.closest('.toggle-comments-btn');
        if (button) {
            handleToggleComments(button);
        }
    });
}

// ======================================================================
// SECTION 2: NEWS PAGE LOGIC
// ======================================================================
let articlesCache = [];
let currentArticleId = null;

async function initializeNewsPage() {
    const articlesGrid = document.getElementById('articles-grid');
    articlesGrid.innerHTML = '<p class="text-center text-gray-400 col-span-full"><i class="fa-solid fa-spinner fa-spin"></i> جاري تحميل الأخبار...</p>';
    try {
        const { data, error } = await supabaseClient.from('articles').select('*').order('created_at', { ascending: false });
        if (error) throw error;
        articlesCache = data;
        renderArticleCards(articlesCache);
    } catch (error) {
        console.error("Error fetching news:", error);
        articlesGrid.innerHTML = `<p class="text-center text-red-500 col-span-full">فشل تحميل الأخبار.</p>`;
    }
    document.getElementById('back-to-news-list').addEventListener('click', () => navigateToNewsSubPage('home'));
    // Dedicated event listener for the news comment form
    document.getElementById('news-comment-form').addEventListener('submit', handleNewsCommentSubmit);
}

function renderArticleCards(articles) {
    const articlesGrid = document.getElementById('articles-grid');
    if (!articles || articles.length === 0) {
        articlesGrid.innerHTML = '<p class="text-center text-gray-400 col-span-full">لا توجد أخبار متاحة حالياً.</p>';
        return;
    }
    articlesGrid.innerHTML = articles.map(article => `
        <div class="article-card" data-article-id="${article.id}">
            <img src="${article.image_url}" alt="${article.title}" onerror="this.style.display='none'">
            <div class="article-title"><h3>${article.title}</h3></div>
        </div>
    `).join('');

    document.querySelectorAll('.article-card').forEach(card => {
        card.addEventListener('click', () => {
            const articleId = card.dataset.articleId;
            renderArticleDetail(parseInt(articleId));
        });
    });
}

function renderArticleDetail(articleId) {
    const article = articlesCache.find(a => a.id === articleId);
    if (!article) return;
    currentArticleId = article.id;
    const articleContent = document.getElementById('article-content');
    articleContent.innerHTML = `
        <div id="article-header"><h1>${article.title}</h1></div>
        <img src="${article.image_url}" alt="${article.title}" onerror="this.style.display='none'">
        <div>${article.content}</div>
    `;
    navigateToNewsSubPage('article');
    fetchAndRenderNewsComments(article.id);
}

function navigateToNewsSubPage(pageName) {
    const homePage = document.getElementById('home-page');
    const articlePage = document.getElementById('article-page');
    if (pageName === 'article') {
        homePage.style.transform = 'translateX(-100%)';
        articlePage.style.transform = 'translateX(0)';
        articlePage.scrollTop = 0;
    } else {
        homePage.style.transform = 'translateX(0)';
        articlePage.style.transform = 'translateX(100%)';
    }
}

async function fetchAndRenderNewsComments(articleId) {
    const commentsList = document.getElementById('news-comments-list');
    commentsList.innerHTML = '<p class="text-center text-gray-400 my-2">جاري تحميل التعليقات...</p>';
    try {
        const { data, error } = await supabaseClient.from('news_comments').select('*').eq('article_id', articleId).order('created_at', { ascending: true });

        if (error) throw error;
        if (data.length === 0) {
            commentsList.innerHTML = '<p class="text-center text-gray-500 my-2">لا توجد تعليقات. كن أول من يعلق!</p>';
        } else {
            commentsList.innerHTML = data.map(comment => `
                <div class="comment-item">
                    <div class="comment-header">
                        <span class="comment-author">${comment.author}</span>
                        <span class="comment-date" style="font-size: 0.8rem;">${new Date(comment.created_at).toLocaleDateString(locale)}</span>
                    </div>
                    <p class="comment-body">${comment.comment_text}</p>
                </div>
            `).join('');
        }
    } catch (err) {
        console.error('Error fetching news comments:', err);
        commentsList.innerHTML = '<p class="text-center text-red-500 my-2">فشل تحميل التعليقات.</p>';
    }
}

async function handleNewsCommentSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const textarea = form.querySelector('textarea');
    const commentText = textarea.value.trim();

    if (!commentText) {
        alert("لا يمكن إرسال تعليق فارغ.");
        return;
    }

    const userInfo = await getUserInfo();
    if (!userInfo) {
        document.getElementById('user-choice-modal').classList.add('show');
        return;
    }

    submitBtn.disabled = true;
    submitBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;

    try {
        const { error } = await supabaseClient.from('news_comments').insert([{
            article_id: currentArticleId,
            user_id: userInfo.id,
            author: userInfo.username,
            comment_text: commentText
        }]);
        if (error) throw error;
        textarea.value = '';
        fetchAndRenderNewsComments(currentArticleId);
    } catch (error) {
        alert('حدث خطأ أثناء إرسال تعليقك.');
        console.error('News comment submission error:', error);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'إرسال التعليق';
    }
}


// ======================================================================
// SECTION 3: HELPER FUNCTIONS (RENDERING, SORTING, ETC.)
// ======================================================================

function getMatchStatus(datetime) {
    const diffMinutes = (new Date(datetime).getTime() - new Date().getTime()) / 60000;
    if (diffMinutes < -125) return 'ended';
    if (diffMinutes <= 0) return 'live';
    if (diffMinutes <= 5) return 'soon';
    return 'scheduled';
}

function sortMatches(matches) {
    const statusOrder = { 'live': 1, 'soon': 2, 'scheduled': 3, 'ended': 4 };
    return matches.sort((a, b) => {
        const statusA = getMatchStatus(a.datetime);
        const statusB = getMatchStatus(b.datetime);
        return statusOrder[statusA] - statusOrder[statusB] || new Date(a.datetime) - new Date(b.datetime);
    });
}

function createMatchCardHTML(match) {
    const status = getMatchStatus(match.datetime);
    const isEnded = status === 'ended';
    const matchDate = new Date(match.datetime);
    let statusHTML;
    switch (status) {
        case 'ended': statusHTML = `<span class="match-status ended">انتهت</span>`; break;
        case 'live': statusHTML = `<span class="match-status live">مباشر</span>`; break;
        case 'soon': statusHTML = `<span class="match-status soon">بعد قليل</span>`; break;
        default: statusHTML = `<div class="match-time">${matchDate.toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit', hour12: true })}</div>`;
    }
    return `
    <div class="match-card" data-match-id="${match.id}">
        <div class="match-header"><span class="match-league">${match.league}</span><span class="match-date-time">${matchDate.toLocaleDateString(locale, { day: 'numeric', month: 'long' })}</span></div>
        <div class="match-body">
            <div class="teams-row">
                <div class="team"><img src="${match.team1.logo}" alt="${match.team1.name}" onerror="this.style.display='none'"><span class="team-name">${match.team1.name}</span></div>
                <div class="match-status-container">${statusHTML}</div>
                <div class="team"><img src="${match.team2.logo}" alt="${match.team2.name}" onerror="this.style.display='none'"><span class="team-name">${match.team2.name}</span></div>
            </div>
            <form name="prediction-form" class="prediction-form ${isEnded ? 'disabled' : ''}">
                <div class="form-group"><legend class="channel-info"><i class="fa-solid fa-tv"></i> <span>${match.channels.join(' / ') || "غير محددة"}</span></legend></div>
                <div class="form-group"><legend>توقع النتيجة:</legend>
                    <div class="prediction-options">
                        <input type="radio" name="winner" id="win1-${match.id}" value="${match.team1.name}" required><label for="win1-${match.id}">${match.team1.name}</label>
                        <input type="radio" name="winner" id="draw-${match.id}" value="تعادل"><label for="draw-${match.id}">تعادل</label>
                        <input type="radio" name="winner" id="win2-${match.id}" value="${match.team2.name}" required><label for="win2-${match.id}">${match.team2.name}</label>
                    </div>
                </div>
                <div class="form-group"><legend>من سيسجل أولاً؟ (اختياري)</legend><input type="text" name="scorer" class="scorer-input" placeholder="اكتب اسم اللاعب..."></div>
                <div class="form-group"><button type="submit" class="submit-btn">${isEnded ? 'أغلقت التوقعات' : 'إرسال التوقع'}</button></div>
            </form>
            
            <div class="match-footer">
                <button class="toggle-comments-btn">
                    <i class="fa-solid fa-comments mr-2"></i> عرض التعليقات
                </button>
                <div class="comments-section">
                    <div class="comment-list p-2">
                        <!-- Comments will be loaded here by JavaScript -->
                    </div>
                    <form class="comment-form" name="match-comment-form">
                        <textarea name="comment_text" placeholder="أضف تعليقك..." required></textarea>
                        <button type="submit">إرسال</button>
                    </form>
                </div>
            </div>
        </div>
    </div>`;
}

function loadPredictionsFromStorage() {
    document.querySelectorAll('.match-card').forEach(card => {
        const matchId = card.dataset.matchId;
        const prediction = JSON.parse(localStorage.getItem(`prediction-${matchId}`));
        if (prediction) {
            const form = card.querySelector('.prediction-form');
            if (form) {
                const winnerRadio = form.querySelector(`input[value="${prediction.winner}"]`);
                if (winnerRadio) winnerRadio.checked = true;
                form.querySelector('.scorer-input').value = prediction.scorer || '';
                [...form.elements].forEach(el => el.disabled = true);
                form.querySelector('.submit-btn').innerHTML = 'تم الإرسال ✅';
            }
        }
    });
}

function populateTicker() {
    const tickerContainer = document.getElementById('news-ticker');
    const tickerContent = document.getElementById('predictions-ticker-content');
    const messages = ["🏆 سيتم تكريم أفضل المتوقعين قريباً!", "💡 سجل دخولك للمشاركة في لوحة الصدارة."];
    if (messages.length > 0) {
        tickerContent.innerHTML = messages.map(msg => `<span class="ticker-item">${msg}</span>`).join('');
        tickerContainer.style.display = 'flex';
    }
}

// ======================================================================
// SECTION 4: AUTH & GUEST USER MANAGEMENT
// ======================================================================

// Function to clear user-specific data from localStorage
function clearUserLocalData() {
    // Loop through all items in localStorage
    Object.keys(localStorage).forEach(key => {
        // If a key starts with "prediction-", remove it
        if (key.startsWith('prediction-')) {
            localStorage.removeItem(key);
        }
    });
    // Also remove guest information
    localStorage.removeItem('guestInfo');
    console.log("User-specific local data cleared for logout.");
}

// Function to reset prediction forms to their initial state
function resetPredictionFormsUI() {
    document.querySelectorAll('.prediction-form').forEach(form => {
        form.reset(); // Clears all inputs (radios, text)
        const submitBtn = form.querySelector('.submit-btn');
        const isEnded = form.classList.contains('disabled');
        
        // Re-enable all elements unless the match has ended
        if (!isEnded) {
             [...form.elements].forEach(el => el.disabled = false);
        }

        // Reset button text and state
        submitBtn.innerHTML = isEnded ? 'أغلقت التوقعات' : 'إرسال التوقع';
    });
    console.log("Prediction forms UI has been reset to default.");
}

function setupAuthAndGuestListeners() {
    const userIconBtn = document.getElementById('user-icon-btn');
    const modal = document.getElementById('user-choice-modal');
    const closeBtn = document.getElementById('close-choice-modal-btn');
    const choiceView = document.getElementById('choice-view');
    const authView = document.getElementById('auth-view');
    const guestView = document.getElementById('guest-view');
    const authStatus = document.getElementById('auth-status-inner');

    function resetModalViews() {
        choiceView.style.display = 'block';
        authView.style.display = 'none';
        guestView.style.display = 'none';
        document.getElementById('login-view-inner').style.display = 'block';
        document.getElementById('signup-view-inner').style.display = 'none';
        authStatus.textContent = '';
    }

    userIconBtn.addEventListener('click', async () => {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
            if (confirm('هل أنت متأكد أنك تريد تسجيل الخروج؟')) {
                 await supabaseClient.auth.signOut();
                 // The onAuthStateChange listener will automatically handle cleaning up the UI
            }
        } else {
            modal.classList.add('show');
            resetModalViews();
        }
    });

    closeBtn.addEventListener('click', () => modal.classList.remove('show'));
    document.getElementById('show-login-view-btn').addEventListener('click', () => { choiceView.style.display = 'none'; authView.style.display = 'block'; });
    document.getElementById('show-guest-view-btn').addEventListener('click', () => { choiceView.style.display = 'none'; guestView.style.display = 'block'; });
    document.getElementById('back-to-choice-btn').addEventListener('click', resetModalViews);
    document.getElementById('show-signup-link-inner').addEventListener('click', e => { e.preventDefault(); document.getElementById('login-view-inner').style.display = 'none'; document.getElementById('signup-view-inner').style.display = 'block'; });
    document.getElementById('show-login-link-inner').addEventListener('click', e => { e.preventDefault(); document.getElementById('signup-view-inner').style.display = 'none'; document.getElementById('login-view-inner').style.display = 'block'; });

    document.getElementById('guest-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const username = document.getElementById('guest-username').value.trim();
        if (username) {
            localStorage.setItem('guestInfo', JSON.stringify({ username }));
            updateUserStatus();
            modal.classList.remove('show');
        }
    });

    document.getElementById('signup-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('signup-username').value;
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        authStatus.textContent = 'جاري إنشاء الحساب...';
        const { error } = await supabaseClient.auth.signUp({ email, password, options: { data: { username } } });
        if (error) { authStatus.textContent = `خطأ: ${error.message}`; authStatus.style.color = 'red'; }
        else { authStatus.textContent = 'تم إرسال رابط التفعيل إلى بريدك الإلكتروني.'; authStatus.style.color = 'green'; }
    });

    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        authStatus.textContent = 'جاري تسجيل الدخول...';
        const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) { authStatus.textContent = `خطأ: ${error.message}`; authStatus.style.color = 'red'; }
        else { authStatus.textContent = 'تم تسجيل الدخول بنجاح!'; authStatus.style.color = 'green'; setTimeout(() => modal.classList.remove('show'), 1500); }
    });
}

async function updateUserStatus() {
    const userIconBtn = document.getElementById('user-icon-btn');
    const userIcon = userIconBtn.querySelector('i');
    const { data: { user } } = await supabaseClient.auth.getUser();
    const guestInfo = JSON.parse(localStorage.getItem('guestInfo'));

    if (user) {
        userIcon.className = 'fa-solid fa-right-from-bracket';
        userIconBtn.title = `تسجيل الخروج (${user.user_metadata.username || user.email})`;
        localStorage.removeItem('guestInfo');
    } else if (guestInfo) {
        userIcon.className = 'fa-solid fa-user-pen';
        userIconBtn.title = `المشاركة كضيف (${guestInfo.username})`;
    } else {
        userIcon.className = 'fa-solid fa-user-plus';
        userIconBtn.title = 'تسجيل الدخول / إنشاء حساب';
    }
}

async function getUserInfo() {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (user) {
        return { id: user.id, username: user.user_metadata.username || user.email };
    }
    const guestInfo = JSON.parse(localStorage.getItem('guestInfo'));
    if (guestInfo) {
        return { id: null, username: guestInfo.username };
    }
    return null;
}

// This is now the central place to manage UI changes on auth state change.
supabaseClient.auth.onAuthStateChange((event, session) => {
    updateUserStatus();

    // If the user has signed out, clean up their local data and reset the forms
    if (event === 'SIGNED_OUT') {
        clearUserLocalData();
        resetPredictionFormsUI();
    }
    
    // If the user has signed in, we reload the predictions from localStorage.
    if (event === 'SIGNED_IN') {
        loadPredictionsFromStorage();
    }
});

// ======================================================================
// SECTION 5: FORM SUBMISSION HANDLER (FOR PREDICTIONS ONLY)
// ======================================================================
async function handleFormSubmit(form) {
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;

    const userInfo = await getUserInfo();
    if (!userInfo) {
        document.getElementById('user-choice-modal').classList.add('show');
        return;
    }
    
    submitBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;
    submitBtn.disabled = true;
    
    const matchId = form.closest('.match-card').dataset.matchId;
    const winnerRadio = form.querySelector('input[name="winner"]:checked');
    if (!winnerRadio) {
        alert('الرجاء اختيار نتيجة المباراة.');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        return;
    }
    
    const predictionData = { 
        match_id: parseInt(matchId), 
        user_id: userInfo.id,
        username: userInfo.username,
        predicted_winner: winnerRadio.value, 
        predicted_scorer: form.querySelector('input[name="scorer"]').value.trim() 
    };

    try {
        const { error } = await supabaseClient.from('predictions').insert([predictionData]);
        if (error) {
            if (error.code === '23505') throw new Error('لقد قمت بالتوقع لهذه المباراة من قبل.');
            else throw error;
        }
        submitBtn.innerHTML = `تم الإرسال ✅`;
        [...form.elements].forEach(el => el.disabled = true);
        
        // Save to localStorage ONLY on successful submission
        localStorage.setItem(`prediction-${matchId}`, JSON.stringify({ winner: predictionData.predicted_winner, scorer: predictionData.predicted_scorer }));

    } catch (error) {
        alert(`حدث خطأ: ${error.message}`);
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}

// ======================================================================
// SECTION 6: MATCH COMMENTS LOGIC
// ======================================================================
async function fetchAndRenderMatchComments(matchId, listElement) {
    listElement.innerHTML = '<p class="text-center text-xs p-2">جاري تحميل التعليقات...</p>';
    try {
        const { data, error } = await supabaseClient
            .from('comments')
            .select('*')
            .eq('match_id', matchId)
            .order('created_at', { ascending: true });

        if (error) throw error;

        if (data.length === 0) {
            listElement.innerHTML = '<p class="text-center text-xs text-gray-500 p-2">لا توجد تعليقات بعد. كن أول من يعلق!</p>';
        } else {
            listElement.innerHTML = data.map(comment => `
                <div class="comment">
                    <div class="comment-avatar"><i class="fa-solid fa-user"></i></div>
                    <div class="comment-body">
                        <span class="comment-author">${comment.author}</span>
                        <p class="comment-text">${comment.comment_text.replace(/\n/g, '<br>')}</p>
                    </div>
                </div>
            `).join('');
        }
    } catch (err) {
        console.error('Error fetching match comments:', err);
        listElement.innerHTML = '<p class="text-center text-red-500 text-xs p-2">فشل تحميل التعليقات.</p>';
    }
}

function handleToggleComments(button) {
    const commentsSection = button.nextElementSibling;
    const isVisible = commentsSection.style.display === 'block';

    if (!isVisible) {
        const matchId = button.closest('.match-card').dataset.matchId;
        const commentList = commentsSection.querySelector('.comment-list');
        fetchAndRenderMatchComments(matchId, commentList);
    }

    commentsSection.style.display = isVisible ? 'none' : 'block';
    button.innerHTML = isVisible 
        ? '<i class="fa-solid fa-comments mr-2"></i> عرض التعليقات' 
        : '<i class="fa-solid fa-eye-slash mr-2"></i> إخفاء التعليقات';
}

async function handleMatchCommentSubmit(form) {
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    const textarea = form.querySelector('textarea');
    const commentText = textarea.value.trim();
    const matchId = form.closest('.match-card').dataset.matchId;

    if (!commentText) {
        return;
    }

    const userInfo = await getUserInfo();
    if (!userInfo) {
        document.getElementById('user-choice-modal').classList.add('show');
        return;
    }
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;
    
    try {
        const { error } = await supabaseClient.from('comments').insert([
            { match_id: matchId, user_id: userInfo.id, author: userInfo.username, comment_text: commentText }
        ]);
        if (error) throw error;
        textarea.value = '';
        fetchAndRenderMatchComments(matchId, form.closest('.comments-section').querySelector('.comment-list'));
    } catch (error) {
        alert('حدث خطأ أثناء إرسال تعليقك.');
        console.error('Match comment submission error:', error);
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

</script>
</body>
</html>
